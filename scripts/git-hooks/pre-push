#!/bin/bash
# Pre-push hook to prevent direct pushes to main branch
# This enforces the feature-branch workflow documented in CLAUDE.md

# ANSI color codes for terminal output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Protected branch name
PROTECTED_BRANCH="main"

# Read from stdin (git provides: <local ref> <local sha> <remote ref> <remote sha>)
while read local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from remote ref (refs/heads/main -> main)
    if [ -n "$remote_ref" ]; then
        remote_branch=$(echo "$remote_ref" | sed 's|refs/heads/||')

        # Check if pushing to protected branch
        if [ "$remote_branch" = "$PROTECTED_BRANCH" ]; then
            echo ""
            echo -e "${RED}╔═══════════════════════════════════════════════════════════╗${NC}"
            echo -e "${RED}║  BLOCKED: Direct push to 'main' branch not allowed       ║${NC}"
            echo -e "${RED}╠═══════════════════════════════════════════════════════════╣${NC}"
            echo -e "${RED}║${NC}  Required workflow:                                        ${RED}║${NC}"
            echo -e "${RED}║${NC}  1. Create feature branch: git checkout -b feat/my-feature${RED}║${NC}"
            echo -e "${RED}║${NC}  2. Push to feature branch: git push origin feat/my-feature${RED}║${NC}"
            echo -e "${RED}║${NC}  3. Open PR on GitHub                                      ${RED}║${NC}"
            echo -e "${RED}║${NC}                                                            ${RED}║${NC}"
            echo -e "${RED}║${NC}  ${YELLOW}Emergency override (use with caution):${NC}                    ${RED}║${NC}"
            echo -e "${RED}║${NC}  ${YELLOW}git push --no-verify origin main${NC}                          ${RED}║${NC}"
            echo -e "${RED}╚═══════════════════════════════════════════════════════════╝${NC}"
            echo ""
            echo -e "For more information, see:"
            echo -e "  - CLAUDE.md (section: Git Workflow > Protected Branches)"
            echo -e "  - .github/BRANCH_PROTECTION.md (GitHub protection setup)"
            echo ""
            exit 1
        fi
    fi
done

# All checks passed - allow the push
exit 0
